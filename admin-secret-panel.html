<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîê Secret Admin Panel</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #0f0f1e;
        color: #e0e0e0;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
      }

      h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .subtitle {
        font-size: 14px;
        opacity: 0.9;
      }

      .auth-section {
        background: #1a1a2e;
        padding: 30px;
        border-radius: 12px;
        border: 1px solid #333;
        margin-bottom: 30px;
        max-width: 500px;
      }

      .auth-section h2 {
        margin-bottom: 20px;
        color: #667eea;
      }

      .input-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-size: 12px;
        text-transform: uppercase;
        color: #999;
        font-weight: 600;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        background: #0f0f1e;
        border: 1px solid #333;
        border-radius: 6px;
        color: #e0e0e0;
        font-size: 14px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        display: inline-block;
        padding: 12px 24px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
      }

      .btn:hover {
        background: #764ba2;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
      }

      .btn:active {
        transform: translateY(0);
      }

      .status-message {
        padding: 12px;
        border-radius: 6px;
        margin-top: 15px;
        font-size: 13px;
      }

      .status-message.success {
        background: rgba(76, 175, 80, 0.1);
        color: #4caf50;
        border: 1px solid #4caf50;
      }

      .status-message.error {
        background: rgba(244, 67, 54, 0.1);
        color: #f44336;
        border: 1px solid #f44336;
      }

      .status-message.info {
        background: rgba(33, 150, 243, 0.1);
        color: #2196f3;
        border: 1px solid #2196f3;
      }

      .hidden {
        display: none;
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #1a1a2e;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #333;
        border-left: 4px solid #667eea;
      }

      .stat-label {
        font-size: 12px;
        text-transform: uppercase;
        color: #999;
        margin-bottom: 10px;
        letter-spacing: 1px;
      }

      .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
      }

      .logs-section {
        background: #1a1a2e;
        border-radius: 12px;
        border: 1px solid #333;
        padding: 20px;
        margin-bottom: 30px;
      }

      .logs-section h2 {
        margin-bottom: 20px;
        color: #667eea;
      }

      .search-input {
        width: 100%;
        max-width: 400px;
        padding: 12px;
        background: #0f0f1e;
        border: 1px solid #333;
        border-radius: 6px;
        color: #e0e0e0;
        margin-bottom: 20px;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      th {
        background: #0f0f1e;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #999;
        border-bottom: 1px solid #333;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 1px;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #333;
      }

      tr:hover {
        background: #0f0f1e;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
      }

      .badge-success {
        background: rgba(76, 175, 80, 0.2);
        color: #4caf50;
      }

      .badge-pending {
        background: rgba(255, 152, 0, 0.2);
        color: #ff9800;
      }

      .badge-email {
        background: rgba(33, 150, 243, 0.2);
        color: #2196f3;
      }

      .badge-sms {
        background: rgba(156, 39, 176, 0.2);
        color: #9c27b0;
      }

      .badge-admin {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
      }

      code {
        background: #0f0f1e;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
        font-size: 11px;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 10px;
      }

      .logout-btn {
        background: #f44336;
        margin-top: 20px;
      }

      .logout-btn:hover {
        background: #d32f2f;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
      }

      .tab-btn {
        padding: 8px 16px;
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-weight: 600;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }

        table {
          font-size: 12px;
        }

        td,
        th {
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üîê Secret Admin Panel</h1>
        <p class="subtitle">
          Decrypt visitor access data (Authorized users only)
        </p>
      </header>

      <!-- Authentication Section -->
      <div class="auth-section" id="authSection">
        <h2>Authenticate</h2>
        <div class="input-group">
          <label>Choose verification method</label>
          <select id="methodSelect" onchange="switchMethod()">
            <option value="email">üìß Email</option>
            <option value="phone">üì± Phone</option>
          </select>
        </div>

        <div id="emailInput" class="input-group">
          <label>Email Address</label>
          <input type="email" id="emailField" placeholder="Enter your email" />
        </div>

        <div id="phoneInput" class="input-group hidden">
          <label>Phone Number</label>
          <input
            type="tel"
            id="phoneField"
            placeholder="Enter your phone number"
          />
        </div>

        <div class="input-group">
          <label>Select Site (get access code)</label>
          <select id="siteSelect">
            <option value="plasmic">üé® Plasmic</option>
            <option value="cubix">üéÆ Cubix</option>
            <option value="fallen-futuristics">üöÄ Fallen Futuristics</option>
            <option value="atlas">üó∫Ô∏è Atlas</option>
            <option value="la-vie">üå∏ La Vie</option>
          </select>
        </div>

        <button class="btn" onclick="requestCode()">Request Code</button>

        <div id="codeInput" class="input-group hidden" style="margin-top: 20px">
          <label>Enter Code from Email/SMS</label>
          <input
            type="text"
            id="codeField"
            placeholder="6-digit code"
            maxlength="6"
          />
          <button
            class="btn"
            onclick="verifyAndLogin()"
            style="margin-top: 10px"
          >
            Verify & Enter Admin Panel
          </button>
        </div>

        <div id="authStatus"></div>
      </div>

      <!-- Admin Dashboard (Hidden until authenticated) -->
      <div id="adminDashboard" class="hidden">
        <!-- Logout Button -->
        <button class="btn logout-btn" onclick="logout()">üö™ Logout</button>

        <!-- Statistics -->
        <div class="dashboard">
          <div class="stat-card">
            <div class="stat-label">Total Access Requests</div>
            <div class="stat-value" id="totalRequests">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Verified Access</div>
            <div class="stat-value" id="verifiedAccess">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Unique Visitors</div>
            <div class="stat-value" id="uniqueVisitors">0</div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="logs-section">
          <h2>üìä Dashboard</h2>
          <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('logs')">
              Access Logs
            </button>
            <button class="tab-btn" onclick="switchTab('sites')">
              Protected Sites
            </button>
          </div>

          <!-- Logs Tab -->
          <div id="logsTab" class="tab-content active">
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="Search by contact, site, or IP..."
              onkeyup="filterLogs()"
            />
            <button
              class="btn"
              onclick="exportCSV()"
              style="max-width: 200px; margin-bottom: 20px"
            >
              üì• Export CSV
            </button>
            <div id="logsContainer">
              <div class="empty-state">
                <div class="empty-state-icon">‚è≥</div>
                <p>Loading access logs...</p>
              </div>
            </div>
          </div>

          <!-- Sites Tab -->
          <div id="sitesTab" class="tab-content">
            <div id="sitesContainer">
              <div class="empty-state">
                <div class="empty-state-icon">‚è≥</div>
                <p>Loading protected sites...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let adminToken = null;
      let adminContact = null;
      let allLogs = [];

      function switchMethod() {
        const method = document.getElementById("methodSelect").value;
        const emailInput = document.getElementById("emailInput");
        const phoneInput = document.getElementById("phoneInput");

        if (method === "email") {
          emailInput.classList.remove("hidden");
          phoneInput.classList.add("hidden");
          document.getElementById("emailField").focus();
        } else {
          emailInput.classList.add("hidden");
          phoneInput.classList.remove("hidden");
          document.getElementById("phoneField").focus();
        }
      }

      async function requestCode() {
        const method = document.getElementById("methodSelect").value;
        const site = document.getElementById("siteSelect").value;
        const statusEl = document.getElementById("authStatus");

        let contact = "";
        if (method === "email") {
          contact = document.getElementById("emailField").value;
          if (!contact.includes("@")) {
            showStatus(statusEl, "Invalid email", "error");
            return;
          }
        } else {
          contact = document.getElementById("phoneField").value;
          if (!contact.startsWith("+")) {
            showStatus(statusEl, "Phone must start with +", "error");
            return;
          }
        }

        try {
          showStatus(statusEl, "Sending code...", "info");
          const endpoint =
            method === "email"
              ? "/api/gated/send-code-email"
              : "/api/gated/send-code-sms";

          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ [method]: contact, site }),
          });

          const data = await response.json();
          if (response.ok) {
            showStatus(
              statusEl,
              `‚úì Code sent to ${data.masked_email || data.masked_phone}`,
              "success",
            );
            document.getElementById("codeInput").classList.remove("hidden");
            document.getElementById("codeField").focus();
            adminContact = contact;
          } else {
            showStatus(statusEl, data.error || "Failed to send code", "error");
          }
        } catch (error) {
          showStatus(statusEl, "Network error", "error");
        }
      }

      async function verifyAndLogin() {
        const code = document.getElementById("codeField").value.trim();
        const site = document.getElementById("siteSelect").value;
        const statusEl = document.getElementById("authStatus");

        if (!code || code.length !== 6) {
          showStatus(statusEl, "Code must be 6 digits", "error");
          return;
        }

        try {
          showStatus(statusEl, "Verifying...", "info");
          const response = await fetch("/api/gated/verify-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              code,
              contact: adminContact,
              site,
            }),
          });

          const data = await response.json();
          if (response.ok && data.is_admin) {
            adminToken = data.token;
            showStatus(statusEl, "‚úì Admin access granted!", "success");
            setTimeout(() => showAdminDashboard(), 1000);
          } else if (!data.is_admin) {
            showStatus(statusEl, "‚ùå You are not authorized as admin", "error");
          } else {
            showStatus(statusEl, "Invalid code", "error");
          }
        } catch (error) {
          showStatus(statusEl, "Verification failed", "error");
        }
      }

      async function showAdminDashboard() {
        document.getElementById("authSection").classList.add("hidden");
        document.getElementById("adminDashboard").classList.remove("hidden");
        await loadStats();
        await loadLogs();
        await loadSites();
      }

      async function loadStats() {
        try {
          const response = await fetch("/api/gated/admin/stats", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: adminToken,
              admin_contact: adminContact,
            }),
          });

          const data = await response.json();
          if (response.ok) {
            document.getElementById("totalRequests").textContent =
              data.total_requests;
            document.getElementById("verifiedAccess").textContent =
              data.verified_access;
            document.getElementById("uniqueVisitors").textContent =
              data.unique_visitors;
          }
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      async function loadLogs() {
        try {
          const response = await fetch("/api/gated/admin/access-logs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: adminToken,
              admin_contact: adminContact,
            }),
          });

          const data = await response.json();
          if (response.ok) {
            allLogs = data.logs || [];
            displayLogs(allLogs);
          } else {
            console.error("Error:", data.error);
          }
        } catch (error) {
          console.error("Error loading logs:", error);
        }
      }

      function displayLogs(logs) {
        if (logs.length === 0) {
          document.getElementById("logsContainer").innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No access logs found</p>
          </div>
        `;
          return;
        }

        let html = `
        <table>
          <thead>
            <tr>
              <th>Contact</th>
              <th>Type</th>
              <th>Site</th>
              <th>IP Address</th>
              <th>Status</th>
              <th>Requested</th>
              <th>Verified</th>
            </tr>
          </thead>
          <tbody>
      `;

        logs.forEach((log) => {
          const badge = log.is_admin_access ? "üëë Admin" : "User";
          const badgeClass = log.is_admin_access
            ? "badge-admin"
            : "badge-email";
          const statusBadge = log.used ? "‚úì Verified" : "‚è≥ Pending";
          const statusClass = log.used ? "badge-success" : "badge-pending";

          html += `
          <tr>
            <td><strong>${maskContact(log.contact, log.contact_type)}</strong></td>
            <td><span class="badge ${log.contact_type === "email" ? "badge-email" : "badge-sms"}">
              ${log.contact_type.toUpperCase()}</span></td>
            <td>${log.site}</td>
            <td><code>${log.ip_address}</code></td>
            <td>
              <span class="badge ${statusClass}">${statusBadge}</span>
              <span class="badge ${badgeClass}">${badge}</span>
            </td>
            <td><small>${new Date(log.created_at).toLocaleString()}</small></td>
            <td><small>${log.accessed_at ? new Date(log.accessed_at).toLocaleString() : "-"}</small></td>
          </tr>
        `;
        });

        html += `</tbody></table>`;
        document.getElementById("logsContainer").innerHTML = html;
      }

      function maskContact(contact, type) {
        if (type === "email") {
          const [local, domain] = contact.split("@");
          return `${local.slice(0, 2)}***@${domain}`;
        } else {
          return contact.slice(0, -4).padEnd(contact.length, "*");
        }
      }

      function filterLogs() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const filtered = allLogs.filter(
          (log) =>
            log.contact.toLowerCase().includes(query) ||
            log.site.toLowerCase().includes(query) ||
            log.ip_address.includes(query),
        );
        displayLogs(filtered);
      }

      function exportCSV() {
        let csv = "Contact,Type,Site,IP Address,Status,Requested,Verified\n";
        allLogs.forEach((log) => {
          csv += `"${log.contact}","${log.contact_type}","${log.site}","${log.ip_address}","${
            log.used ? "Verified" : "Pending"
          }","${new Date(log.created_at).toISOString()}","${
            log.accessed_at ? new Date(log.accessed_at).toISOString() : "-"
          }"\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `admin-access-logs-${new Date().toISOString().split("T")[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      async function loadSites() {
        try {
          const response = await fetch("/api/gated/admin/get-sites", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: adminToken,
              admin_contact: adminContact,
            }),
          });

          const data = await response.json();
          if (response.ok) {
            const sitesHtml = data.sites
              .map(
                (
                  site,
                ) => `<div style="padding: 12px; background: #0f0f1e; border-radius: 6px; margin-bottom: 10px;">
              <strong>${site}</strong>
            </div>`,
              )
              .join("");

            document.getElementById("sitesContainer").innerHTML = `
            <div style="color: #e0e0e0;">
              <p style="margin-bottom: 20px;">Protected sites (encrypted):</p>
              ${sitesHtml}
            </div>
          `;
          }
        } catch (error) {
          console.error("Error loading sites:", error);
        }
      }

      function switchTab(tab) {
        document.querySelectorAll(".tab-content").forEach((el) => {
          el.classList.remove("active");
        });
        document.querySelectorAll(".tab-btn").forEach((el) => {
          el.classList.remove("active");
        });

        document.getElementById(tab + "Tab").classList.add("active");
        event.target.classList.add("active");
      }

      function logout() {
        adminToken = null;
        adminContact = null;
        document.getElementById("authSection").classList.remove("hidden");
        document.getElementById("adminDashboard").classList.add("hidden");
        document.getElementById("emailField").value = "";
        document.getElementById("phoneField").value = "";
        document.getElementById("codeField").value = "";
        document.getElementById("codeInput").classList.add("hidden");
        document.getElementById("authStatus").innerHTML = "";
        document.getElementById("methodSelect").value = "email";
        switchMethod();
      }

      function showStatus(element, message, type) {
        element.innerHTML = `<div class="status-message ${type}">${message}</div>`;
      }

      // Focus on email field on load
      window.addEventListener("load", () => {
        document.getElementById("emailField").focus();
      });
    </script>
  </body>
</html>
